name: Security Pipeline

on:
  push:
    branches:
      - main
  pull_request:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      # ----------------------
      # CHECKOUT CODE
      # ----------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ----------------------
      # SETUP JAVA (SonarQube)
      # ----------------------
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ----------------------
      # INSTALL DEPENDENCIES
      # ----------------------
      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
          elif [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            echo "No dependency file found, skipping installation"
          fi

      # ----------------------
      # OPTIONAL: UNIT TEST
      # ----------------------
      - name: Run tests (Optional)
        continue-on-error: true
        run: |
          if [ -f "package.json" ]; then
            npm test || true
          elif [ -f "pytest.ini" ]; then
            pytest || true
          else
            echo "No test config found, skipping tests"
          fi

      # ----------------------
      # SAST: SONARQUBE SCAN
      # ----------------------
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v2
        env:
          SONAR_HOST_URL: ${{ secrets.SONAR_HOST_URL }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      # Agar tidak gagal hanya karena quality gate FAIL,
      # workflow tetap lanjut sehingga pipeline TIDAK berhenti.
      - name: SonarQube Quality Gate
        uses: SonarSource/sonarqube-quality-gate-action@v1
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      # ----------------------
      # DAST: OWASP ZAP
      # ----------------------
      - name: Run ZAP Baseline Scan
        env:
          ZAP_TARGET_URL: ${{ secrets.ZAP_TARGET_URL }}
        run: |
          echo "Starting OWASP ZAP scan on: $ZAP_TARGET_URL"

          docker run \
            -v $(pwd):/zap/wrk \
            -t ghcr.io/zaproxy/zaproxy:stable \
            zap-baseline.py \
            -t $ZAP_TARGET_URL \
            -r zap_report.html

      # ----------------------
      # UPLOAD ARTIFACT: ZAP REPORT
      # ----------------------
      - name: Upload ZAP Report
        uses: actions/upload-artifact@v4
        with:
          name: ZAP-DAST-Report
          path: zap_report.html
          retention-days: 5

      # ----------------------
      # OPTIONAL: UPLOAD SONAR REPORTS
      # ----------------------
      - name: Upload SonarQube Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: SonarQube-Reports
          path: ./
          retention-days: 5
