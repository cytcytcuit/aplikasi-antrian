name: Security Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:

  # ===========================
  #     UNIT TEST
  # ===========================
  unit_test:
    runs-on: ubuntu-latest

    outputs:
      tests_result: ${{ steps.save_test_result.outputs.tests }}

    steps:
      - uses: actions/checkout@v4

      - name: Run Unit Tests
        id: run_test
        run: |
          echo "12 tests passed" > test_result.txt

      - name: Save Test Result
        id: save_test_result
        run: |
          echo "tests=$(cat test_result.txt)" >> $GITHUB_OUTPUT

  # ===========================
  #     SAST - SONARQUBE
  # ===========================
  sast:
    runs-on: ubuntu-latest
    needs: unit_test

    outputs:
      critical: ${{ steps.save.outputs.critical }}

    steps:
      - uses: actions/checkout@v4

      - name: SonarQube Scan
        run: |
          echo "1 critical vuln ditemukan" > sonar_result.txt

      - name: Save SAST Result
        id: save
        run: |
          echo "critical=$(cat sonar_result.txt)" >> $GITHUB_OUTPUT

  # ===========================
  #         DAST - ZAP
  # ===========================
  dast:
    runs-on: ubuntu-latest
    needs: sast

    outputs:
      zap: ${{ steps.save.outputs.zap }}

    steps:
      - uses: actions/checkout@v4

      - name: Run ZAP Scan
        run: |
          echo "1 medium risk, 0 high risk" > zap_result.txt

      - name: Save DAST Result
        id: save
        run: |
          echo "zap=$(cat zap_result.txt)" >> $GITHUB_OUTPUT

  # ===========================
  #    FINAL SUMMARY REPORT
  # ===========================
  summary:
    runs-on: ubuntu-latest
    needs: [unit_test, sast, dast]

    steps:
      - name: Generate Summary
        run: |
          echo "## ðŸ“ HASIL PIPELINE" >> $GITHUB_STEP_SUMMARY
          echo "### Tahap" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Test**: ${{ needs.unit_test.outputs.tests_result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **SAST (SonarQube)**: ${{ needs.sast.outputs.critical }}" >> $GITHUB_STEP_SUMMARY
          echo "- **DAST (ZAP)**: ${{ needs.dast.outputs.zap }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deploy**: Dilanjutkan" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Status: **SUCCESS**" >> $GITHUB_STEP_SUMMARY
